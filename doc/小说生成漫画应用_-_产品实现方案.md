# 小说生成漫画应用 - 产品实现方案

## 1. 项目概述

本项目旨在开发一个AIGC应用，能够将输入的小说文本自动转换成漫画形式。应用的核心是利用大型语言模型（LLM）进行文本理解和分镜创作，并结合文生图（Text-to-Image）模型生成视觉画面。

## 2. 系统架构

本应用将采用前后端分离的架构，通过API进行通信。整体系统由三个核心部分组成：前端用户界面、后端服务和第三方AIGC模型服务。

| 组件 | 技术选型 | 主要职责 |
| :--- | :--- | :--- |
| **前端 (Frontend)** | React / Vue.js | 提供用户交互界面，包括文本输入、风格选择、漫画预览与下载。 |
| **后端 (Backend)** | Python (FastAPI) | 处理核心业务逻辑，包括文本处理、与AIGC服务交互、任务管理、数据存储。 |
| **AIGC服务** | 火山引擎AIGC | 提供底层的LLM（Doubao）、文生图（seedream 4.0）和TTS（doubao tts）能力。 |
| **数据库** | PostgreSQL | 存储用户信息、项目文件、生成的漫画数据、角色设定等。 |
| **任务队列** | Celery & Redis | 管理耗时的AIGC生成任务，实现异步处理，避免请求超时。 |

### 架构图描述

1.  **用户**通过**前端界面**输入小说文本，并选择漫画风格、角色设定等参数。
2.  **前端**将请求发送至**后端API网关**。
3.  **后端服务**接收到请求后，将耗时的生成任务（如分镜生成、图像生成）放入**任务队列（Celery）**中进行异步处理。
4.  **任务执行单元（Worker）**从队列中获取任务，并调用相应的**AIGC服务API（Google Gemini, Imagen）**。
5.  **AIGC服务**返回生成结果（如分镜描述、图像数据）。
6.  **后端服务**将结果存入**数据库**，并更新任务状态。
7.  **前端**通过轮询或WebSocket与**后端**通信，获取任务状态和最终的漫画结果，并呈现给用户。

## 3. 核心工作流程

从用户输入小说到生成最终漫画，主要包含以下步骤：

1.  **小说文本获取及生成：** 用户输入已有小说文本，后端首先进行预处理，去除无关字符。然后，利用LLM（Doubao）对文本进行分析，识别章节、段落，并初步切分出不同的场景（Scene）。
    *   **已有文本：** 用户已准备好的小说文本，通常是从网络获取或自行创作的（pdf/epub/txt格式）。

    *   **未有文本：** 用户未准备小说文本，用户输入主题，调用LLM（Doubao）生成符合主题的小说文本

2.  **文本预处理与场景切分：** 获得小说文本后，后端首先进行预处理，去除无关字符。然后，利用LLM（Doubao）对文本进行分析，识别章节、段落，并初步切分出不同的场景（Scene）。

3.  **角色/风格一致性选择及管理：** 在首次生成角色时，允许用户上传参考图或通过详细描述确定角色的关键特征。
    *   **人物主体：** 允许用户上传参考图或通过详细描述确定角色的关键特征（如发型、服装、配饰），在后续生成中，将这些特征作为固定的Prompt元素（以及参考图片）来确保角色形象的统一。
    *   **画面风格：** 为保证风格统一，所有项目都会包含一个共同的风格描述前缀（例如，“in a Japanese anime style, vibrant colors, clean line art”）。

4.  **分镜脚本生成 (Storyboard Generation)：** 针对每个场景，结合角色描述，再次调用LLM，将其细化为一系列漫画分镜（Panel）。每个分镜都包含一段详细的描述性文本（Prompt），内容涵盖：
    *   **画面主体：** 包含哪些角色，他们的动作、姿态和表情。
    *   **场景环境：** 描述背景、道具和氛围。
    *   **镜头语言：** 定义视角（如远景、特写）、构图和光影效果。
    *   **对话/旁白：** 提取或生成该分镜对应的文本内容。

5.  **图像生成 (Image Generation)：** 将每个分镜的描述性文本（Prompt）发送给文生图模型（Imagen），生成对应的漫画图像。为保证风格统一，所有Prompt都会包含一个共同的风格描述前缀（例如，“in a Japanese anime style, vibrant colors, clean line art”）。

6.  **文本气泡与布局 (Text Bubble Placement)：**
    *   利用LLM提取或生成的对话和旁白文本。
    *   通过图像分析技术识别生成图像中的视觉焦点和留白区域。
    *   自动将文本放入合适形状的对话气泡中，并智能地放置在留白区域，避免遮挡关键画面。同时进行字体、大小的适配。

7.  **页面合成 (Page Composition)：** 根据预设的漫画页面布局（如四格、六格），将多个分镜图像和文本气泡组合成一个完整的漫画页面。

8.  **漫画输出：** 将所有生成的页面按顺序组合成一部完整的漫画，提供给用户在线预览，并支持导出为PDF或图片集。

## 4. 模块设计

后端服务将包含以下核心模块：

*   **文本分析模块 (Text Analysis Module):**
    *   **功能：** 负责小说的预处理、场景切分和情节摘要。
    *   **实现：** 调用Gemini API，使用精心设计的Prompt来完成文本的结构化分析。

*   **分镜创作模块 (Storyboard Generation Module):**
    *   **功能：** 将场景文本转化为详细的分镜描述（Prompts for image generation）。
    *   **实现：** 再次调用Gemini API，利用其强大的文学创作和视觉想象能力，生成高质量的分镜脚本。

*   **图像生成模块 (Image Generation Module):**
    *   **功能：** 调用文生图API，根据分镜脚本生成图像。
    *   **实现：** 封装对Google Imagen API的调用，管理API Key，处理请求和响应，并对生成失败的情况进行重试或错误处理。

*   **风格与角色管理模块 (Style & Character Management Module):**
    *   **功能：** 存储和管理用户选择的漫画风格和角色设定。
    *   **实现：** 通过数据库记录风格关键词和角色特征描述。在生成图像时，将这些信息动态地注入到Prompt中。

*   **漫画合成模块 (Comic Composition Module):**
    *   **功能：** 将生成的图像、文本气泡按照指定布局组合成最终的漫画页面。
    *   **实现：** 使用Pillow或OpenCV等Python图像处理库，进行图像的拼接、裁剪和文本叠加。

## 5. 一周竞赛开发计划

| 时间 | 任务 | 产出 |
| :--- | :--- | :--- |
| **Day 1-2** | **环境搭建与API集成** | - 后端FastAPI项目初始化。<br>- 完成Doubao和doubao Imagen API的调用封装与测试。<br>- 数据库模型设计与创建。 |
| **Day 3-4** | **核心逻辑开发** | - 实现文本分析与分镜生成模块。<br>- 实现图像生成与风格控制逻辑。<br>- 完成角色一致性的初步方案（基于Prompt）。 |
| **Day 5** | **前端界面开发** | - 开发用于文本输入、风格选择的用户界面。<br>- 实现漫画结果的展示页面。 |
| **Day 6** | **前后端集成与测试** | - 联调前后端接口，打通完整流程。<br>- 进行功能测试，修复关键Bug。<br>- 实现异步任务处理，优化用户体验。 |
| **Day 7** | **文档完善与部署** | - 整理并最终确定需求文档和产品实现方案。<br>- 准备项目演示材料。<br>- （可选）将应用部署到云服务器进行展示。 |

